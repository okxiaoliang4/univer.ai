import { Callout, Steps, Tabs } from 'nextra/components'

# Deploy to Kubernetes

Kubernetes is a powerful open-source platform for orchestrating containerized applications, automating their deployment, scaling, and management. In this guide, we'll leverage Helm, Kubernetes' package manager, to streamline our deployment process.

## Technical Overview

Deploy Univer backend services on Kubernetes involves several key components:

- **Kubernetes Cluster**: The environment where your app resides.
- **Helm**: The deployment and management tool for apps on Kubernetes. Require Helm 3.
- **Database and Messaging**: PostgreSQL and RabbitMQ services.

## Installing Helm

Head over to the [Helm installation guide](https://helm.sh/docs/intro/install/) to get started.
Once installed, confirm Helm's presence by executing:

```bash
helm version
```

## Deployment Steps

<Steps>
  ### Kubernetes Cluster Setup

  Make sure you have an active Kubernetes cluster. For cloud providers like Google Kubernetes Engine (GKE) or Amazon Elastic Kubernetes Service (EKS), adhere to their specific instructions for cluster creation.

  ### Deploy Univer services

  1. Use Helm to deploy Univer services:

  ```bash
  helm install univer --create-namespace \
      --set global.istioNamespace=univer \
      oci://univer-acr-registry.cn-shenzhen.cr.aliyuncs.com/helm-charts/univer-stack

  kubectl rollout restart deployment/collaboration-server -n univer
  kubectl rollout restart deployment/universer -n univer
  ```

  2. To check if your deployment is up and running:

  ```bash
  kubectl get pods
  ```

  3. Deploy observability component
  ```bash
  helm upgrade --install -n univer-observability --create-namespace \
      --set global.univerNamespace="univer" \
      univer-observability oci://univer-acr-registry.cn-shenzhen.cr.aliyuncs.com/helm-charts/univer-observability
  ```

  ### Deployment Verification

  ```bash
  # For quick testing, you might edit your local hosts file to map the domain.
  # Default domain: univer.example.com

  Visit: http://univer.example.com/sheet/
  ```
</Steps>

## Offline Deployment

If you need to deploy in an offline environment, we also provide an offline installation package.

<Steps>

  ### Download the offline installation package

  [Click here to download the offline installation package](https://univer.ai/releases/univer-server/download) and extract it on your server.

  ```bash
  tar -xvf installation-package.tar # Replace 'installation-package' with the actual file name
  ```

  ### Upload image to privite registry

  Remember, you need to login to the private container image registry before running the script.
 
  ```bash
  bash load-image.sh --registry ${YOUR_REGISTRY} --namespace ${YOUR_IMAGE_NAMESPACE}
  ```

  ### Install univer service

  The script need `helm` and `kubectl`.

  ```bash
  bash install.sh
  ```

  ### Verify that the service is available.

  ```bash
  # For quick testing, you might edit your local hosts file to map the domain.
  # Default domain: univer.example.com

  Visit: http://univer.example.com/sheet/
  ```
</Steps>

### How to uninstall

```bash
bash uninstall.sh
```
## Custom config

See [https://github.com/dream-num/helm-charts](https://github.com/dream-num/helm-charts) for default helm chart values config, or you can run `helm show values oci://univer-acr-registry.cn-shenzhen.cr.aliyuncs.com/helm-charts/univer-observability` to get it.

Cross helm guidance, you can write a values.yaml to change the default config and use `helm upgrade --values values.yaml ...` to update univer service.

### USIP

```yaml
universer:
  config:
    usip:
      enabled: true
      uri:
        userinfo: "http://192.168.1.100:8080/userinfo"
        collaborators: "http://192.168.1.100:8080/collaborators"
        role: "http://192.168.1.100:8080/role"
        credential: "http://192.168.1.100:8080/credential"
```

### Database

Change universer and temporal database.

<Tabs items={['PostgreSQL', 'MySQL']}>
  <Tabs.Tab label="PostgreSQL">
    ```yaml
    universer:
      config:
        database:
          driver: postgresql
          host: postgresql
          port: 5432
          dbname: univer
          username: postgres
          password: postgres

    temporal:
      server:
        config:
          persistence:
            default:
              driver: "sql"
              sql:
                driver: "postgres12"
                host: postgresql
                port: 5432
                database: temporal
                user: postgres
                password: postgres

            visibility:
              driver: "sql"
              sql:
                driver: "postgres12"
                host: postgresql
                port: 5432
                database: temporal_visibility
                user: postgres
                password: postgres
    ```
  </Tabs.Tab>
  <Tabs.Tab label="MySQL">
    ```yaml
    universer:
      config:
        database:
          driver: mysql
          host: mysql
          port: 3306
          dbname: univer
          username: root
          password: mysql

    temporal:
      server:
        config:
          persistence:
            default:
              driver: "sql"
              sql:
                driver: "mysql8"
                host: mysql
                port: 3306
                database: temporal
                user: root
                password: mysql

            visibility:
              driver: "sql"
              sql:
                driver: "mysql8"
                host: mysql
                port: 33006
                database: temporal_visibility
                user: root
                password: mysql
    ```
  </Tabs.Tab>
</Tabs>

### Redis

```yaml
universer:
  config:
    redis:
      poolSize: 100
      # if use redis cluster, use comma to separate multiple redis servers
      # for example: redis1:6379,redis2:6379
      addr: redis:6379
      read_timeout: 1s
      write_timeout: 1s
      db: 0
      username: ""
      password: ""
```

### S3

<Tabs items={['minio', 'aliyun oss', 'aws s3']}>
  <Tabs.Tab label="minio">
    ```yaml
    universer:
      config:
        s3:
          accessKeyID: admin
          accessKeySecret: minioadmin
          region: "us-east-1"
          endpoint: http://minio:9000
          endpointPublic: ""
          usePathStyle: true
          defaultBucket: univer
    ```
  </Tabs.Tab>
  <Tabs.Tab label="aliyun oss">
    ```yaml
    universer:
      config:
        s3:
          accessKeyID: "${YOUR_ACCESS_KEY_ID}"
          accessKeySecret: "${YOUR_ACCESS_KEY_SECRET}"
          region: oss-cn-shenzhen
          endpoint: https://oss-cn-shenzhen-internal.aliyuncs.com
          endpointPublic: https://oss-cn-shenzhen.aliyuncs.com
          usePathStyle: false
          defaultBucket: univer
    ```
  </Tabs.Tab>
  <Tabs.Tab label="aws s3">
    ```yaml
    universer:
      config:
        s3:
          accessKeyID: "${YOUR_ACCESS_KEY_ID}"
          accessKeySecret: "${YOUR_ACCESS_KEY_SECRET}"
          region: "us-east-1"
          endpoint: https://s3.amazonaws.com
          endpointPublic: https://s3.amazonaws.com
          usePathStyle: false
          defaultBucket: univer
    ```
  </Tabs.Tab>
</Tabs>

### RabbitMQ

```yaml
universer:
  config:
    rabbitmq:
      cluster:
        enabled: true
        # use comma to separate multiple addresses
        # for example: RABBITMQ_CLUSTER_ADDR=192.168.1.2:5672,192.168.1.5:5672,192.168.1.7:5672
        addr: "192.168.1.2:5672"
        username: "admin"
        password: "rabbitmq"
        vhost: "/"
        schema: amqp
```

## Troubleshooting

If your service isn't launching, verify the status of your Kubernetes Pods and consult the logs for clues.

If you're still having issues, feel free to <a class="nx-text-primary-600 nx-underline nx-decoration-from-font [text-underline-position:from-font]" href="mailto:developer@univer.ai?subject=[Univer Services]">contact us</a> for assistance.

### Can not download oci ?

The `helm` require version >= 3, if version is less than 3.8, it should set enviroment `export HELM_EXPERIMENTAL_OCI=1
` to open OCI feature. See [helm document](https://helm.sh/docs/topics/registries/).